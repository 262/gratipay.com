import locale
from gittip import db, get_backed_amount

def rows(goals):
    for rec in goals:

        # What's a hundred db calls between friends? *blush*
        so_far = get_backed_amount(rec['id'])

        row = [ rec['id']
              , rec['goal']
              , so_far
              , (so_far / rec['goal']) * 100
               ]
        yield row

def sortfunc(a, b):
    percentage = cmp(a[3], b[3])
    if percentage != 0:             # percentage descending
        return percentage * -1
    else:                           # goal, id ascending
        return cmp((a[1], a[0]), (b[1], a[1]))

# ==== ^L

ngoals = db.fetchone("SELECT count(id) FROM participants WHERE goal > 0")
ngoals = ngoals['count'] if ngoals is not None else 0
goals = db.fetchall(""" \

    SELECT id, goal
      FROM participants
     WHERE goal > 0
  ORDER BY goal DESC

""")
goals = goals if goals is not None else []
rows = list(rows(goals))
rows.sort(cmp=sortfunc)


# ==== ^L
{% extends templates/base.html %}
{% block body %}
<p class="below-header"><a href="./">About</a></p>
<style>
    TH, TD {
        padding-right: 1em;
    }
</style>

<h2>{{ ngoals}} people have set a funding goal.</h2>
<table>
    <tr>
        <th>Participant</th>
        <th style="text-align: right;">Goal ($)</a></th>
        <th colspan="2">Backed ($, %)</a></th>
    </tr>
    {% for participant_id, goal, backed, percentage in rows %}
    <tr>
        <th><a href="/{{ participant_id }}/">{{ participant_id }}</a></th>
        <td>{{ locale.format("%.2f", goal, grouping=True) }}</td>
        <td>{{ locale.format("%.2f", backed, grouping=True) }}</td>
        <td>{{ "%5.1f" % percentage }}</td>
    </tr>
    {% end %}
</table>
{% end %}
