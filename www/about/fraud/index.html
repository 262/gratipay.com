from aspen import Response
from gittip import db

^L
if not user.ADMIN:
    raise Response(404)


_suspicious = db.fetchall("""

    SELECT id
         , balance
      FROM participants
     WHERE is_suspicious

""")
if _suspicious is None:
    _suspicious = []


def suspicious():
    for person in _suspicious:
        person['gives_to'] = db.fetchall("""

            SELECT DISTINCT tippee AS id
                 , is_suspicious
              FROM tips
              JOIN participants p
                ON tippee = p.id
             WHERE tipper=%s


        """, (person['id'],))
        person['receives_from'] = db.fetchall("""

            SELECT DISTINCT tipper AS id
                 , is_suspicious
              FROM tips
              JOIN participants p
                ON tipper = p.id
             WHERE tippee=%s

        """, (person['id'],))

        person['transfers'] = db.fetchall("""

            SELECT tippee
                 , tipper
                 , amount
              FROM transfers
             WHERE tipper=%s OR tippee=%s
          ORDER BY timestamp DESC


        """, (person['id'], person['id']))

        person['exchanges'] = db.fetchall("""

            SELECT amount, fee
              FROM exchanges
             WHERE participant_id=%s
          ORDER BY timestamp DESC


        """, (person['id'],))

        yield person
suspicious = list(suspicious())
names = set([person['id'] for person in suspicious])

^L
<style>
    TABLE {
        width: auto;
    }
    TD, TH {
        text-align: left;
        vertical-align: top;
        border-bottom: 1px solid #B2A196;
    }
    .amount {
        text-align: right;
        padding-right: 1em;
        font-family: Lucida Mono, monospace;
        }
    .suspicious {
        font-weight: bold;
        color: red;
    }
    .charge {
        color: red;
    }
</style>
<h3>Fraud, Grommit!</h3>
<table>
    <tr>
        <th>Suspicious Person</th>
        <th></th>
        <th>Balance</th>
        <th>Tips</th>
        <th>Transfers</th>
        <th>Exchanges</th>
    </tr>
    {% for row in suspicious %}
    <tr>
        <td><a href="/{{ row['id'] }}/">{{ row['id'] }}</a></td>
        <td class="dollar-sign">$</td>
        <td class="amount">{{ row['balance'] }}</td>
        <td>
            {% for person in row['gives_to'] %}
                &rarr;<a href="/{{ person['id'] }}/"{% if person['is_suspicious'] %} class="suspicious"{% end %}>{{ person['id'] }}</a><br />
            {% end %}
            {% for person in row['receives_from'] %}
                &larr;<a href="/{{ person['id'] }}/"{% if person['is_suspicious'] %} class="suspicious"{% end %}>{{ person['id'] }}</a><br />
            {% end %}
        </td>
        <td>
            {% for transfer in row['transfers'] %}
                {% if row['id'] == transfer['tipper'] %}
                <span class="amount">{{ str(transfer['amount']).rjust(6).replace(' ', '&nbsp;') }}</span>&rarr;
                <a href="/{{ transfer['tippee'] }}/"{% if transfer['tippee'] in names %} class="suspicious"{% end %}>{{ transfer['tippee'] }}</a><br />
                {% else %}
                <span class="amount">{{ str(transfer['amount']).rjust(6).replace(' ', '&nbsp;') }}</span>&larr;
                <a href="/{{ transfer['tipper'] }}/"{% if transfer['tipper'] in names %} class="suspicious"{% end %}>{{ transfer['tipper'] }}</a><br />
                {% end %}
            {% end %}
        </td>
        <td>
            {% for exchange in row['exchanges'] %}
            <span class="amount{% if exchange['amount'] < 0 %} charge{% end %}">
                {{ str(exchange['amount']).rjust(7).replace(' ', '&nbsp;') }}
                {{ str(exchange['fee']).rjust(4).replace(' ', '&nbsp;') }}
            </span><br />
            {% end %}
        </td>
    </tr>
    {% end %}
</table>
<br />
<hr />
