import datetime
from gittip import db, utils

# ========================================================================== ^L

paydays = db.fetchall("SELECT * FROM paydays ORDER BY ts_start")
npeople = db.fetchone("SELECT count(*) AS n FROM participants WHERE claimed_time IS NOT NULL")['n']
ncredit_card = db.fetchone("SELECT count(*) AS n FROM participants WHERE last_bill_result = ''")['n']
percentage_credit_card = float("%5.1f" % ((ncredit_card * 100.0) / npeople))
statements = db.fetchall("SELECT id, statement FROM participants WHERE statement != '' LIMIT 100")
statements = [{'id': r['id'], 'statement': utils.wrap(r['statement'])} for r in statements]

tip_amounts = db.fetchone("""
        SELECT avg(amount), sum(amount)
         FROM (    SELECT DISTINCT ON (tipper, tippee) amount
                     FROM tips
                     JOIN participants p ON p.id = tipper
                     JOIN participants p2 ON p2.id = tippee
                    WHERE p.last_bill_result = ''
                      AND p2.claimed_time IS NOT NULL
                 ORDER BY tipper, tippee, mtime DESC
               ) AS foo; 
""")
if tip_amounts is None:
    average_tip = 0
    total_backed_tips = 0
else:
    average_tip = tip_amounts['avg']
    total_backed_tips = tip_amounts['sum']

average_tippees = db.fetchone("""\
        SELECT round(avg(ntippees))
          FROM ( SELECT count(tippee) as NTIPPEES 
                   FROM ( SELECT DISTINCT ON (tipper, tippee) tipper, tippee 
                            FROM tips
                            JOIN participants p ON p.id = tipper
                            JOIN participants p2 on p2.id = tippee
                           WHERE p.last_bill_result = ''
                             AND p2.claimed_time IS NOT NULL
                             AND amount > 0
                        GROUP BY tipper, tippee, mtime
                        ORDER BY tipper, tippee, mtime DESC
                         ) AS foo GROUP BY tipper) AS bar
""")['round']
average_tippees = 0 if average_tippees is None else int(average_tippees)

response.body = {}
response.body['paydays'] = list(paydays)
response.body['npeople'] = npeople
response.body['ncredit_card'] = ncredit_card
response.body['percentage_credit_card'] = percentage_credit_card
response.body['statements'] = statements
response.body['average_tip'] = average_tip
response.body['average_tippees'] = average_tippees
response.body['total_backed_tips'] = total_backed_tips
