"""This page allows users to file their credit card details with us.
"""
import datetime

import samurai.config
from aspen import Response
from logstown import db
from samurai.payment_method import PaymentMethod

#=========================================================================== ^L

if request.user.ANON:
    request.redirect('/sign/in/then/subscribe.html')

if request.POST:
    raise Response(405)


# Get the user's payment_method_token, if they have one.
# ======================================================
# If it comes to us in the querystring, that means we're getting a redirect
# back from Samurai, and we want to save it. Otherwise we expect it in the 
# session.

pmt = request.qs.one('payment_method_token')
if pmt is not None: # We got sent back here after POSTing ourself to Samurai.
    session_token = request.user.session['session_token']
    PMT = "UPDATE users SET payment_method_token=%s WHERE session_token=%s"
    db.execute(PMT, (pmt, session_token,))
else:
    pmt = request.user.session.get('payment_method_token')


# Download details from Samurai.
# ==============================
# If the user has not submitted this form at all yet, then pmt will be None.

if pmt is not None:
    pmt = {}
    #pmt = PaymentMethod.find(pmt)


# Set up some content helpers.
# ============================

def get(name):
    out = ""
    if pmt is not None:
        out = getattr(pmt, name, "")
        if out is None:
            out = ""
    return out

def get_last_four():
    last_four = get('last_four_digits')
    if last_four:
        last_four = "************" + last_four
    return last_four

def gen_months():
    for month in range(1, 13):
        target = get('expiry_month') # returns int
        yield ( month
              , str(month).zfill(2)
              , ' selected="true"' if month == target else ""
               )

def gen_years():
    # XXX Make this smarter to extend the range to include the users's actual 
    # year (their card expires in 2011 and they don't login again until 2012, 
    # e.g.)
    this_year = datetime.datetime.now().year
    for year in range(this_year, this_year + 5):
        target = get('expiry_year') # returns int
        yield (year, ' selected="true"' if year == target else "")


title = "Subscribe"

#=========================================================================== ^L
{% extends form.html %}
{% block head2 %}
<style>
</style>
<script>
    Logstown.wire('informed', function()
    {
        var action = 'https://api.samurai.feefighters.com/v1/payment_methods';
        $('FORM').attr('action', action);
    });
</script>
{% end %}
{% block already %}

<div id="unpegged-2" class="unpegged">
    <h3><span><b>Step 1 <i>of</i> 3:</b> Register or Sign In</span></h3>
    <div class="line"></div>

    <p>You are signed in as {{ request.user.session['email'] }}. <a
        href="/sign/out.html">Sign out</a>.</p>


</div>

{% end %}
{% block form %}

    2 3 Credit Card Details 

    [50]First Name;[50]Last Name
    Address 1
    Address 2
    [55]City;[15]State;[30]ZIP
    *[75]Card Number;*[25]CVV
    *Expiration
    (submit)Save Credit Card Details|Saving Credit Card Details

    (hidden)redirect_url"{{ request.x.base }}/subscribe.html" \
    (hidden)merchant_key"{{ samurai.config.merchant_key }}" \
    {% if samurai.config.sandbox %}(hidden)sandbox"true" \
    {% end %}
    {% if pmt %}(hidden)payment_method_token"{{ pmt.payment_method_token }}" \
    {% end %}
        
{% end %}
