"""Associate a Bountysource account with a Gittip account.

First, must receive token from Bountysource by authorizing the application.
"""
from urllib import urlencode

from aspen import Response
from gittip.elsewhere import bountysource

# ========================== ^L

if user.ANON:
    raise Response(404)

# did something go wrong with account link at Bountysource?
# redirect to profile page, where an error will be displayed
if 'error' in qs:
    new_qs = urlencode({'error': qs['error']})
    request.redirect('/on/bountysource/error.html?%s' % new_qs)

# Gittip generated access token, passed all the way through the auth process
token = qs.get('access_token', '')

# find participant from Bountysource created access token.
# it better be the logged in user, dammit.
participant = bountysource.get_participant_via_access_token(token)

# Don't raise 400, just go to profile.
# This will be the case if the user clicks the 'Reject' button
# on the Bountysource account authorize screen.
if not participant or participant != user:
    # raise Response(400)
    request.redirect('/%s' % user.username)

else:
    # create a linked account
    params = bountysource.filter_params(qs)
    account = bountysource.BountysourceAccount(params['id'], params)

    # associate with the Gittip participant
    user.take_over(account)

    request.redirect('/%s' % account.participant)

# ========================== ^L text/plain
