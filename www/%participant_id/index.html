"""Show information about a single participant.
"""
import locale

import requests
from aspen import json, Response
from aspen.utils import to_age
from gittip import AMOUNTS
from gittip.models import Participant
from gittip.utils import get_participant, wrap

tip_suggestions = ('jeresig', 'antirez', 'wycats', 'fabpot', 'mitsuhiko',
                   'jtauber', 'kennethreitz', 'alex', 'taylorotwell')
tip_suggestions = [{'tippee': name, 'amount': 0} for name in tip_suggestions]

MAKING = "I am making the world better by"

def _clip(text, n):
    text = text.replace('\n', ' ')
    if len(text) > n:
        text = text[:(n - 4)] + '...'
    return text

# ========================================================================== ^L

participant = get_participant(request)


# Load money info.
# ================

backed_amount = participant.get_dollars_receiving()

if not user.ANON:
    if user.id == participant.id or user.ADMIN:
        giving_chart, npatrons, contributed = \
                                           participant.get_chart_of_receiving()
    if user.id == participant.id:
        tips, total, unclaimed_tips, unclaimed_total = \
                                                  user.get_giving_for_profile()
        if total == 0:
            tips = tip_suggestions
        assert backed_amount == contributed, (backed_amount, contributed)
    else:
        my_tip = user.get_tip_to(participant.id)


# Set a few more things.
# ======================

can_tip = True
tip_or_pledge = "tip"
title = participant.id      # used in <title>
username = participant.id   # used in footer shared with on/$platform/ pages
github_account, twitter_account = participant.get_accounts_elsewhere()

# ========================================================================== ^L
{% extends templates/participant.html %}
{% block head %}
    <meta name="twitter:card" content="summary" />
    <meta name="og:url" content="https://www.gittip.com/{{ username }}/" />
    <meta name="og:type" content="website" />
    <meta name="og:title" content="{{ participant.get_og_title() }}" />
    <meta name="og:description" content="{{ _clip(MAKING + " " + participant.statement, 200) }}" />
    <meta name="og:image" content="https://www.gittip.com/assets/gittip.opengraph.png" />
    <script src="/assets/{{ __version__ }}/profile.js"></script>
    {% if user.ADMIN %}
    <script src="/assets/{{ __version__ }}/admin.js"></script>
    {% end %}
    <script>$(document).ready(Gittip.initTipButtons)</script>
{% end %}
{% block heading %}
<h2 class="top"><span>Profile</span></h2>
{% end %}
{% block page %}

    <style>
        /** This is blatantly copied from stats.html. We should really fix
            that somehow. **/
        .dollar-sign {
            padding: 0 2pt 0 24pt;
            text-align: right;
        }
        /*
        .amount {
            padding: 0 6pt 0 0;
            text-align: right;
        }
        */
        .amount-change {
            padding: 6pt 0 6pt 24pt;
            text-align: left;
        }
        .count {
            text-align: left;
            white-space: nowrap;
        }
        .count SPAN.number {
            font-size: 8pt;
        }
        .count SPAN.bar {
            background: #B2A196;
            display: inline-block;
            margin-right: 3pt;
            height: 9pt;
        }
        FORM.statement TEXTAREA {
            width: 98%;
            height: 126pt; /* 18pt * 7 rows; overriden in js */
            padding: 1%
        }
        FORM BUTTON {
            float: right;
            margin-left: 0.5em;
        }
        SPAN.participant_id {
            display: none;
        }
        SPAN.participant_id FORM {
            display: inline;
        }
        SPAN.participant_id FORM BUTTON {
            float: none;
            margin-left: 0;
        }
        SPAN.participant_id INPUT {
            width: 6em;
            font-weight: 900;
        }
        FORM.goal {
            display: none;
        }
        FORM.goal TD {
            text-align: left;
        }
        FORM.goal TD.buttons {
            padding-top: 6pt;
        }
        #goal-custom {
            text-align: right;
            width: 6pc;
        }
        LI {
            margin-bottom: 1em;
        }
        .count SPAN.bar.green {
            background: #2A8F79;
        }
        #their-voice.is-suspicious {
            background: #FFE2DE;
        }
        .editing #username_edit_warning {
            margin-top: 1em;
            display: block;
            color: red;
        }
        #username_edit_warning {
            display: none;
        }

    </style>

    {% if participant.id == 'aaronsw' %}
    <style>
        .rip {
            text-align: center;
            font-size: larger;
            margin: 3em 0;
        }
    </style>
    <div class="rip">
        <a href="http://news.ycombinator.com/item?id=5046845">RIP</a> :`(
    </div>
    <!--

    After following Aaron's career for a decade, I interacted with him for the
    first time three days before he committed suicide:

        https://twitter.com/aaronsw/status/288664016723791873

    :`(

    -->
    {% end %}

{% if not user.ANON and user.id == participant.id %}
    {% include "templates/profile-edit.html" %}
{% else %}

<div class="col1">
    <h2>Contribution</h2>
    {% if participant.statement %}
    <div class="statement">{{ MAKING }} {{ wrap(participant.statement) }}</div>
    {% end %}
</div>
<div class="col2">

    <h2>Funding Goal</h2>
    <div class="goal">
        {% if participant.goal is None %}
        I&rsquo;m grateful for tips, but I don&rsquo;t have a specific funding goal.
        {% elif participant.goal == 0 %}
        I&rsquo;m not here to receive tips. I&rsquo;ll generally regift them.
        {% else %}
        My goal is to receive ${{ locale.format("%.2f", participant.goal, grouping=True) }} per week on Gittip.
        {% end %}
        </div>

    {% include "templates/connected-accounts.html" %}
</div>
{% end %}

<div class="clear"></div>

{% if user.ADMIN %}
<p style="text-align: right">
    <input name="is_suspicious" class="is-suspicious-knob" type="checkbox"
        {% if participant.is_suspicious %}checked="true"{% end %} />
    <label for="is_suspicious" class="is-suspicious-knob">Suspicious</label>
</p>
{% end %}

{% end %}
