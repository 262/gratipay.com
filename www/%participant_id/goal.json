import locale
import decimal

from aspen import Response
from gittip import db

# ========================================================================== ^L

if user.ANON:
    raise Response(404)
request.allow("POST")

goal = request.body["goal"]

if goal == "null":
    goal = None
elif goal == "custom":
    goal = request.body["goal_custom"].replace(',', '')

if goal is not None:
    try:
        goal = decimal.Decimal(goal)
    except decimal.InvalidOperation:
        raise Response(400, "Bad input.")

GOAL = """\

    INSERT INTO goals
                (ctime, participant, amount)
         VALUES ( COALESCE (( SELECT ctime
                                FROM goals
                               WHERE (participant=%s)
                               LIMIT 1
                              ), CURRENT_TIMESTAMP)
                , %s, %s
                 )
         RETURNING amount

"""
rec = db.fetchone( GOAL
                 , (user.id, user.id, goal)
                  )

goal = rec['amount']
if goal is not None:
    goal = locale.format("%.2f", rec['amount'], grouping=True)
response.body = {"goal": goal}
