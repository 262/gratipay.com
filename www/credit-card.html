"""This page allows users to file their credit card details with us.
"""
import datetime

import samurai.config
from logstown import db
from samurai.payment_method import PaymentMethod

#=========================================================================== ^L


# Get the user's payment_method_token, if they have one.
# ======================================================
# If it comes to us in the querystring, that means we're getting a redirect
# back from Samurai, and we want to save it. Otherwise we expect it in the 
# session.

pmt = request.qs.one('payment_method_token')
if pmt is not None: # We got sent back here after POSTing ourself to Samurai.
    session_token = request.user.session['session_token']
    PMT = "UPDATE users SET payment_method_token=%s WHERE session_token=%s"
    db.execute(PMT, (pmt, session_token,))
else:
    pmt = request.user.session.get('payment_method_token')


# Download details from Samurai.
# ==============================
# If the user has not submitted this form at all yet, then pmt will be None.

if pmt is not None:
    pmt = PaymentMethod.find(pmt)


# Set up some content helpers.
# ============================

def get(name):
    out = ""
    if pmt is not None:
        out = getattr(pmt, name, "")
        if out is None:
            out = ""
    return out

def get_last_four():
    last_four = get('last_four_digits')
    if last_four:
        last_four = "************" + last_four
    return last_four

def gen_months():
    for month in range(1, 13):
        target = get('expiry_month') # returns int
        yield ( month
              , str(month).zfill(2)
              , ' selected="true"' if month == target else ""
               )

def gen_years():
    this_year = datetime.datetime.now().year
    for year in range(this_year, this_year + 5):
        target = get('expiry_year') # returns int
        yield (year, ' selected="true"' if year == target else "")


#=========================================================================== ^L

{% extends "base.html" %}
{% block head %}
<style>@import url("https://samurai.feefighters.com/assets/api/0.1/samurai-540ad0fe1d10267c4f468150b02e6e3f.css");</style> 
<script>
    $(document).ready(function() {
        $('#credit_card_first_name').focus();
    });
</script>
{% end %}


{% block content %}
<h2>Save Credit Card on File</h2>

<p>Feel free to <a href="/pay-money.html">pay money</a> with this credit
card.</p>

<div class="samurai-standard samurai-placeholders">
    <form action="https://api.samurai.feefighters.com/v1/payment_methods" 
          method="POST" class="samurai">

        <input name="redirect_url" type="hidden" 
            value="{{ request.x.base }}/credit-card.html" />
        <input name="merchant_key" type="hidden" 
            value="7b79175baca336eaf4bfe8c8" />
        <input name="sandbox" type="hidden" value="true" />
        {% if pmt %}
        <input name="payment_method_token" type="hidden" 
            value="{{ pmt.payment_method_token }}" />
        {% end %}

        <fieldset>
            <div class="field-group" id="credit_card_name_group">
                <div>
                    <label for="credit_card_first_name">First name</label>
                    <input id="credit_card_first_name" 
                        name="credit_card[first_name]" 
                        size="30" type="text" value="{{ get('first_name') }}" 
                        placeholder="First Name">
                </div>
                <div>
                    <label for="credit_card_last_name">Last name</label>
                    <input id="credit_card_last_name" 
                    name="credit_card[last_name]" size="30" type="text" 
                    value="{{ get('last_name') }}" placeholder="Last Name">
                </div>
            </div>
            <div class="field-group" id="credit_card_address_group">
                <div>
                    <label for="credit_card_address_1">Address 1</label>
                    <input class="div-6" id="credit_card_address_1" 
                    name="credit_card[address_1]" size="30" type="text" 
                    value="{{ get('address_1') }}" placeholder="Address">
                </div>
                <div>
                    <label for="credit_card_address_2">Address 2</label>
                    <input class="div-6" id="credit_card_address_2" 
                    name="credit_card[address_2]" size="30" type="text" 
                    value="{{ get('address_2') }}" 
                    placeholder="Apartment or Suite">
                </div>
            </div>
            <div class="field-group" id="location_group">
                <div>
                    <label for="credit_card_city">City</label>
                    <input id="credit_card_city" name="credit_card[city]" 
                    size="30" type="text" value="{{ get('city') }}" 
                    placeholder="City">
                </div>
                <div>
                    <label for="credit_card_state">State</label>
                    <input class="div-1" id="credit_card_state" 
                    name="credit_card[state]" size="30" type="text" 
                    value="{{ get('state') }}" placeholder="State">
                </div>
                <div>
                    <label for="credit_card_zip">Zip</label>
                    <input class="div-2" id="credit_card_zip" 
                    name="credit_card[zip]" size="30" type="text" 
                    value="{{ get('zip') }}" placeholder="Zipcode">
                </div>
            </div>
        </fieldset>
        <fieldset>
            <div class="field-group" id="credit_card_info_group">
                <div>
                    <label for="credit_card_card_number">Card number</label>
                    <input id="credit_card_card_number" 
                        name="credit_card[card_number]" size="30" type="text" 
                        value="{{ get_last_four() }}" autocomplete="off" 
                        placeholder="Credit Card Number">
                    <label data-samurai-card-previews="" class="show-accepted">
                        <span class="visa"></span>
                        <span class="mastercard"></span>
                        <span class="amex"></span>
                        <span class="discover"></span>
                    </label>
                </div>
                <div id="samurai_card_cvv">
                    <label for="credit_card_cvv">CVV</label>
                    <input class="div-1" id="credit_card_cvv" 
                    name="credit_card[cvv]" size="30" type="text" 
                    value="{{ get('cvv') }}" autocomplete="off" 
                    placeholder="CVV">
                </div>
            </div>
            <div class="field-group" id="credit_card_expiration">
                <div>
                    <label for="credit_card_expiry_month">Expires on</label>
                    <select id="credit_card_expiry_month" 
                        name="credit_card[expiry_month]">
                        {% for val, display, selected in gen_months() %}
                        <option value="{{ val }}"{{ selected }}>{{ display }}</option>
                        {% end %}
                    </select>
                    <select id="credit_card_expiry_year" 
                        name="credit_card[expiry_year]">
                        {% for val, selected in gen_years() %}
                        <option value="{{ val }}"{{ selected }}>{{ val }}</option>
                        {% end %}
                    </select>
                </div>
            </div>
        </fieldset>
        <button type="submit" class="button">Save Credit Card on File</button>
        <!--span class="loading" style=""></span-->
        <span class="results" style="display: none;"></span>
</form>
</div>

{% end %}
